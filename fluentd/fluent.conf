<source>
  @type tail # pathで指定されたファイルを取得し続ける
  # path /opt/minecraft_server/logs/latest.log # 取得するマイクラのログのパス
  path ./minecraft/logs/latest.log
  format /^\[(?<time>.*)\]\s\[(?<caused_at>[^/]*)/(?<level>.*)\]:\s(?<log>.*)$/ # formatを指定
  time_format %H:%M:%S # 時間のフォーマットを指定
  pos_file ./fluentd/pos/minecraft.pos # tailプラグインでどこまで読み込んだかを記憶する
  tag debug.minecraft.log # タグを設定
</source>

<filter debug.minecraft.log>
  @type grep # grepプラグインを使用
  <regexp>
    key log # json内のlogキーの値が対象
    pattern (joined|left) # joinedかleftが含まれるログをマッチさせる
  </regexp>
</filter>

<match debug.minecraft.log>
  # @type stdout # マッチしたらログに出力します
  # @type            line_notify # line_notifyプラグインを使用
  # access_token     your token # トークンを設定
  # message_template <%= record['log'] %> # 送信する内容を設定（logキーを出力）

  @type mysql_bulk
  host "#{ENV['MYSQL_HOST']}"
  port "#{ENV['MYSQL_PORT']}"
  database "#{ENV['MYSQL_DATABASE']}"
  username "#{ENV['MYSQL_USER']}"
  password "#{ENV['MYSQL_PASSWORD']}"
  include_time_key yes

  # 2018-04-21 19:02:33.000000000 +0900 debug.minecraft.log: {"caused_at":"Server thread","level":"INFO","log":"username joined the game"}
 
  column_names id,caused_at,level,log,created_at
  key_names id,caused_at,level,log,${time}
  table operation_log
 
  flush_interval 10s
</match>